---
description: 
globs: memory-bank/user-test/*.md
alwaysApply: false
---
# Automated User Testing with Token-Based Authentication

This document outlines the rules and procedures for conducting automated user testing for the VibeCulture application, utilizing token-based authentication to streamline the process. This involves using Supabase as the database and browser interaction tools for simulating user actions.

## Core Principles

1.  **Fully Automated Token-Based Authentication:** To eliminate manual login steps in automated tests, we will use JWT access tokens passed via URL query parameters (`?token=YOUR_ACCESS_TOKEN`). These tokens can be generated automatically by scripts.
2.  **Dedicated Test Users & Credentials in Environment Variables:** All automated tests should run under a dedicated test user account in Supabase. The credentials for this test user (`TEST_EMAIL`, `TEST_PASSWORD`), along with Supabase connection details (`NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`), must be stored as environment variables (e.g., in `.env.local` for local testing or CI/CD environment variables).
3.  **Supabase for Data Verification:** Test assertions will often involve verifying data states in the Supabase database.
4.  **Browser Tools for UI Interaction:** Browser automation tools will be used to simulate user navigation, form submissions, and other UI interactions.

## Generating a Test User JWT Access Token (Fully Automated)

A Node.js script is available at `scripts/get-test-token.js` to facilitate obtaining an access token for a test user in a fully automated way.

**Prerequisites:**

*   Ensure your environment (e.g., `.env.local` file or CI/CD environment variables) contains:
    ```
    NEXT_PUBLIC_SUPABASE_URL=https://mhzcyixvauzvlbfjghba.supabase.co
    NEXT_PUBLIC_SUPABASE_ANON_KEY=your_actual_anon_key 
    TEST_EMAIL=your_test_user_email@example.com
    TEST_PASSWORD=your_test_user_password
    ```
    (Replace placeholders with your actual Supabase anon key and test user credentials).
*   Have the dedicated test user (specified by `TEST_EMAIL`) already created in your Supabase project (Authentication -> Users).

**Steps to Generate Token:**

1.  Ensure the environment variables listed above are correctly set.
2.  From your project root, run the script:
    ```bash
    node scripts/get-test-token.js
    ```
3.  The script will automatically use the environment variables to authenticate and will output an `Access Token` to the console. This output can be captured by other scripts or CI processes.

## Using the Token in Automated Tests

When an automated test needs to simulate an authenticated user:

1.  **Obtain the Token:** Execute the `scripts/get-test-token.js` script and capture its output. *Note: These tokens are typically short-lived, so a new token might be needed for each test run or session.*
2.  **Construct the URL:** Append the captured token as a query parameter to the target URL. For example, to access the profile page:
    `http://localhost:3000/profile?token=CAPTURED_ACCESS_TOKEN`
3.  **Navigate:** The browser automation tool should navigate to this constructed URL. The `AuthProvider` in the application is designed to detect this token, authenticate the session with Supabase, and then remove the token from the URL.

## Example Test Flow (Conceptual for Automation)

1.  **Setup (Automated):**
    *   A test runner script executes `node scripts/get-test-token.js` and stores the output (the access token).
2.  **Test Action (e.g., Submit a New Event):**
    *   Browser tool is launched and navigates to `http://localhost:3000/submit-event?token=STORED_ACCESS_TOKEN`.
    *   Browser tool fills out the event submission form.
    *   Browser tool clicks the "Submit" button.
3.  **Verification (Automated):**
    *   **UI:** Browser tool checks for a success message or redirection.
    *   **Database (Supabase):** Automated script queries the `events` table (using Supabase client library or API calls) to confirm the new event's existence and properties.
4.  **Teardown (Automated, Optional):**
    *   Automated script deletes any test data created in Supabase.

## Considerations

*   **Token Expiration:** For long-running test suites, tokens might expire. Ensure your test strategy accounts for this, perhaps by generating a new token per test or per logical group of tests.
*   **Security of Credentials:** Test user credentials (`TEST_EMAIL`, `TEST_PASSWORD`) and the Supabase anon key should be managed securely, especially in CI/CD environments, using secrets management features provided by the CI/CD platform.
*   **Test Environment Isolation:** Always run automated tests that modify data against a dedicated testing or staging Supabase environment, not the production database.

This fully automated approach to token generation is crucial for efficient and reliable CI/CD pipelines and automated testing practices. 